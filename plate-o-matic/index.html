<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gFLOCK Plate-o-Matic (Offline)</title>
    
    <link rel="icon" type="image/png" href="irene.png">

    <style>
        /* --- Base Styles & Fonts --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-image: url('ONBUSINESS.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #ec4899;
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        /* --- Animations --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* --- Main Layout --- */
        .main-container {
            width: 100%;
            max-width: 42rem;
            /* Increased opacity to improve readability over the background */
            background-color: rgba(255, 240, 245, 0.6); 
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(244, 114, 182, 0.3);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* --- Typography with Text Shadow for Readability --- */
        .text-shadow {
            /* Added text-shadow to make text pop against any background */
            text-shadow: 0px 2px 4px rgba(0, 0, 0, 0.5);
        }
        .text-center { text-align: center; }
        .title-h1 {
            font-size: 3.75rem;
            font-weight: 700;
            color: #db2777;
        }
        .title-h2 {
            font-size: 1.5rem;
            color: #ec4899;
            margin-top: 0.5rem;
        }
        .text-pink-400 { color: #f472b6; }
        .text-pink-500 { color: #ec4899; }
        .text-pink-600 { color: #db2777; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }

        /* --- Forms & Inputs --- */
        .input-section-wrapper {
             display: flex;
             flex-direction: column;
             gap: 0.75rem;
        }
        .input-section {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        @media (min-width: 640px) {
            .input-section {
                flex-direction: row;
            }
        }
        .plate-input, .local-state-select {
            width: 100%;
            padding: 0.75rem 1.25rem;
            font-size: 1.125rem;
            color: #be185d;
            background-color: #fff1f2;
            border: 2px solid #fce7f3;
            border-radius: 1rem;
            transition: all 0.2s ease-in-out;
        }
        .plate-input:focus, .local-state-select:focus {
            outline: none;
            border-color: #f9a8d4;
            box-shadow: 0 0 0 4px rgba(244, 114, 182, 0.3);
        }
        .check-button {
            background-color: #ec4899;
            color: white;
            font-weight: 700;
            font-size: 1.125rem;
            padding: 0.75rem 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(236, 72, 153, 0.3), 0 2px 4px -2px rgba(236, 72, 153, 0.3);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        .check-button:hover {
            background-color: #db2777;
            transform: scale(1.05);
        }
        .check-button:active {
            transform: scale(0.95);
        }
        .label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #ec4899;
            margin-bottom: 0.25rem;
        }

        /* --- Batch Upload --- */
        .batch-section {
             display: flex;
             flex-direction: column;
             gap: 0.75rem;
        }
        .dashed-border {
            border-top: 2px dashed #fbcfe8;
            padding-top: 1.5rem;
        }
        .file-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 8rem;
            border: 2px dashed #f9a8d4;
            border-radius: 1rem;
            cursor: pointer;
            background-color: #fff1f2;
            transition: background-color 0.2s ease-in-out;
        }
        .file-upload-label:hover {
            background-color: #fce7f3;
        }
        .file-upload-label svg {
            width: 2.5rem;
            height: 2.5rem;
            margin-bottom: 0.75rem;
            color: #f472b6;
        }
        .hidden-input {
            display: none;
        }
        .batch-results-container {
            display: none;
            flex-direction: column;
            gap: 0.75rem;
        }
        .csv-output {
            width: 100%;
            height: 12rem;
            padding: 0.75rem;
            background-color: #fff1f2;
            border: 2px solid #fce7f3;
            border-radius: 0.5rem;
        }
        .download-button {
            width: 100%;
            background-color: #22c55e;
            color: white;
            font-weight: 700;
            padding: 0.75rem;
            border-radius: 0.75rem;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        .download-button:hover {
            background-color: #16a34a;
            transform: scale(1.05);
        }

        /* --- Results --- */
        .results-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .result-card {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #fce7f3;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            color: #4b5563;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-state-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #db2777;
        }
        .card-vehicle-class {
            font-size: 1rem;
            font-weight: 400;
            color: #6b7280;
        }
        .card-confidence-badge {
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
        }
        .card-notes {
            text-align: left;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            color: #6b7280;
        }
        .bg-high { background-color: #22c55e; }
        .bg-medium-high { background-color: #3b82f6; }
        .bg-medium { background-color: #eab308; }
        .bg-low-medium { background-color: #f97316; }
        .bg-low { background-color: #ef4444; }
        
        .error-message {
            background-color: #fee2e2;
            border: 1px solid #f87171;
            color: #b91c1c;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Main Container -->
    <div class="main-container">
        
        <div class="text-center">
            <h1 class="title-h1 text-shadow">gFLOCK</h1>
            <h2 class="title-h2 text-shadow">can this plate exist?</h2>
            <p class="text-pink-400 mt-2 text-shadow">Enter a license plate to see if it's a valid format!</p>
            <p class="text-pink-400 mt-2 text-xs text-shadow"> Note: This app does not know if a plate number is real or not, if it's registration is expired, or anything of that nature. It uses regex to make sure any given string does not violate the rules set by each U.S. state for lisence plate numbers. It might not even do that correctly. As-is, no warranties.  Thje state of origin feature is highly experimental, and under even ideal circumstances is probably impossible to make 100% accurate. The serial numbering conventions across states are too similar, a better approach would be "this number can't be from this state,:" probably. There is no way to stop the music on purpose, this took extra effort to vibe code. Should run 100% completely offline, no requests to external sites if you clone this entire directory.  </p>
        </div>

        <!-- Input Section -->
        <div class="input-section-wrapper">
            <div class="input-section">
                <input type="text" id="plateInput" placeholder="Type a plate number here! â™¡" class="plate-input">
                <button id="validateBtn" class="check-button">
                    Check!
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.9 1.9-1.1-3-1.1 3L6 6l3 1.1-3 1.1 1.9 1.9 1.1 3 1.1-3L12 18l-1.9-1.9-1.1 3-1.1-3L6 18l3-1.1-3-1.1L7.9 12 6 10.1l-1.1 3-1.9-1.9L1.9 12l3-1.1-3-1.1L6 6l1.9 1.9 1.1-3 1.1 3L12 3Z"/><path d="M21 12h-2"/><path d="M12 21v-2"/></svg>
                </button>
            </div>
            <!-- Local State Selector -->
            <div>
                <label for="localStateSelect" class="label text-shadow">Local State (Optional)</label>
                <select id="localStateSelect" class="local-state-select">
                    <option value="">None</option>
                    <!-- Options will be populated by JS -->
                </select>
                <p class="text-xs text-pink-400 mt-1 text-shadow">Selecting a state will boost its confidence score to prioritize local results.</p>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="results-container"></div>

        <!-- Batch Processing Section -->
        <div class="dashed-border batch-section">
            <div class="text-center">
                <h2 class="title-h2 text-shadow" style="font-size: 1.875rem; color: #db2777;">Process a Bunch!</h2>
                <p class="text-pink-400 mt-1 text-shadow">Upload a .csv file to check lots of plates~</p>
            </div>
            
            <div>
                <label for="csvFileInput" class="file-upload-label">
                    <div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>
                        <p class="text-lg text-pink-500">â™¡ Click to Upload a CSV File â™¡</p>
                    </div>
                </label>
                <input id="csvFileInput" type="file" class="hidden-input" accept=".csv"/>
            </div>

            <div id="batchResultsContainer" class="batch-results-container">
                <h3 class="text-xl font-semibold text-center text-pink-500">Here are your results!</h3>
                <textarea id="csvOutput" readonly class="csv-output"></textarea>
                <button id="downloadCsvBtn" class="download-button">
                    Download Results
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Data Definitions ---
        const rules = [
            { "state": "Alabama", "vehicle_class": "Passenger", "regex": "^[1-9][0-9]?[A-Z0-9]{5,6}$", "years_active": "2022-Pres", "constraints": { "exclude_global": ["I", "O", "Q"], "coded_info": { "type": "County", "positions": [0, 2], "mapping_key": "alabama_county_codes" } }, "notes": "Identified by the mandatory numeric county code (1-67) at the beginning of the plate.", "identification_confidence": "High", "confidence_score": 99 },
            { "state": "Hawaii", "vehicle_class": "Passenger", "regex": "^[A-Z]{3}[0-9]{3}$", "years_active": "1991-Pres", "constraints": { "coded_info": { "type": "Prefix", "positions": [0, 1], "mapping_key": "hawaii_county_codes" } }, "notes": "Identified by the first letter, which is a mandatory county code (e.g., H for Hawai'i County).", "identification_confidence": "High", "confidence_score": 98 },
            { "state": "Idaho", "vehicle_class": "Passenger", "regex": "^(1A|1B|1C|1G|1L|1M|1T|1U|2C|2L|B|C|E|F|G|J|K|L|M|N|O|P|S|T|V|W)[A-Z0-9\\s]+$", "years_active": "2008-Pres", "constraints": { "coded_info": { "type": "Prefix", "positions": [0, 2], "mapping_key": "idaho_county_codes" } }, "notes": "Identified by the one or two character county code prefix (e.g., 1A for Ada, B for Bannock).", "identification_confidence": "High", "confidence_score": 99 },
            { "state": "Montana", "vehicle_class": "Passenger", "regex": "^[1-9][0-9]?[A-Z0-9\\s]+$", "years_active": "Current", "constraints": { "coded_info": { "type": "County", "positions": [0, 2], "mapping_key": "montana_county_codes" } }, "notes": "Identified by the mandatory numeric county code (1-56) at the beginning of the plate.", "identification_confidence": "High", "confidence_score": 99 },
            { "state": "Nebraska", "vehicle_class": "Passenger", "regex": "^[1-9][0-9]?[A-Z0-9\\s]+$", "years_active": "Current", "constraints": { "coded_info": { "type": "County", "positions": [0, 2], "mapping_key": "nebraska_county_codes" } }, "notes": "Identified by the mandatory numeric county code (1-93) at the beginning of the plate.", "identification_confidence": "High", "confidence_score": 99 },
            { "state": "South Dakota", "vehicle_class": "Passenger", "regex": "^[1-9][0-9]?[A-Z0-9\\s]+$", "years_active": "Current", "constraints": { "coded_info": { "type": "County", "positions": [0, 2], "mapping_key": "south_dakota_county_codes" } }, "notes": "Identified by the mandatory numeric county code (1-67) at the beginning of the plate.", "identification_confidence": "High", "confidence_score": 99 },
            { "state": "Wyoming", "vehicle_class": "Passenger", "regex": "^[1-9][0-9]?[A-Z0-9\\s]+$", "years_active": "Current", "constraints": { "coded_info": { "type": "County", "positions": [0, 2], "mapping_key": "wyoming_county_codes" } }, "notes": "Identified by the mandatory numeric county code (1-23) at the beginning of the plate.", "identification_confidence": "High", "confidence_score": 99 },
            { "state": "West Virginia", "vehicle_class": "Passenger", "regex": "^[1-9OND][A-Z]{2}[0-9]{3}$", "years_active": "Current", "constraints": { "coded_info": { "type": "Month", "positions": [0, 1], "mapping_key": "west_virginia_month_codes" } }, "notes": "Identified by the first character, which indicates the expiration month (1-9, O, N, D).", "identification_confidence": "High", "confidence_score": 98 },
            { "state": "Massachusetts", "vehicle_class": "Passenger", "regex": "^[0-9A-Z]+[0-9]$", "years_active": "1993-Pres", "constraints": { "exclude_global": ["Q", "U"], "coded_info": { "type": "Month", "positions": [-1, 0], "mapping_key": "massachusetts_month_codes" } }, "notes": "Identified by the last digit, which indicates the expiration month (0-9). This is a general rule for many MA plate types.", "identification_confidence": "High", "confidence_score": 98 },
            { "state": "Missouri", "vehicle_class": "Passenger", "regex": "^[A-Z]{2}[0-9][A-Z][0-9][A-Z]$", "years_active": "2008-Pres", "constraints": { "exclude_global": ["I", "O", "Q"], "coded_info": { "type": "Month", "positions": [0, 1], "mapping_key": "missouri_month_codes" } }, "notes": "Identified by the unique AB1 C2D format and the first letter, which indicates the expiration month.", "identification_confidence": "High", "confidence_score": 98 },
            { "state": "California", "vehicle_class": "Passenger", "regex": "^[1-9][A-Z]{3}[0-9]{3}$", "years_active": "1980-Pres", "constraints": { "positional": [ { "position": 1, "exclude": ["I", "O", "Q"] }, { "position": 3, "exclude": ["I", "O", "Q"] } ] }, "notes": "Unique 1ABC234 format. The letters I, O, and Q are not used in the first or third letter positions.", "identification_confidence": "High", "confidence_score": 95 },
            { "state": "California", "vehicle_class": "Future Passenger", "regex": "^[0-9]{3}[A-Z]{3}[0-9]$", "years_active": "~2027-", "constraints": { "exclude_global": ["I", "O", "Q"] }, "notes": "Projected future format 123ABC4. Assumes standard I/O/Q exclusions.", "identification_confidence": "High", "confidence_score": 95 },
            { "state": "Delaware", "vehicle_class": "Passenger", "regex": "^[1-9][0-9]{0,5}$", "years_active": "1969-Pres", "constraints": {}, "notes": "Identified by the all-numeric format with up to 6 digits.", "identification_confidence": "High", "confidence_score": 95 },
            { "state": "Texas", "vehicle_class": "Passenger", "regex": "^[A-Z]{3}[0-9]{4}$", "years_active": "2012-Pres", "constraints": { "exclude_global": ["A", "E", "I", "O", "U", "Q"] }, "notes": "Identified by the powerful rule excluding all vowels (A, E, I, O, U) and Q.", "identification_confidence": "High", "confidence_score": 99 },
            { "state": "Tennessee", "vehicle_class": "Passenger", "regex": "^[A-Z]{3}[0-9]{4}$", "years_active": "2022-Pres", "constraints": { "exclude_global": ["A", "E", "I", "O", "U"] }, "notes": "Identified by the powerful rule excluding all vowels (A, E, I, O, U).", "identification_confidence": "High", "confidence_score": 99 },
            { "state": "New Mexico", "vehicle_class": "Passenger (Chile)", "regex": "^[A-Z]{4}[0-9]{2}$", "years_active": "Current", "constraints": { "exclude_global": ["E", "I", "O", "Q", "U", "V"] }, "notes": "Unique ABCD12 format combined with a very strict character exclusion list.", "identification_confidence": "High", "confidence_score": 95 },
            { "state": "Kentucky", "vehicle_class": "Passenger", "regex": "^[A-Z][0-9][A-Z][0-9]{3}$", "years_active": "2021-Pres", "constraints": { "exclude_global": ["I", "Q", "U"] }, "notes": "Unique A1B 234 format combined with character exclusions.", "identification_confidence": "High", "confidence_score": 95 },
            { "state": "Maryland", "vehicle_class": "Passenger", "regex": "^[0-9][A-Z]{2}[0-9]{4}$", "years_active": "2016-Pres", "constraints": {}, "notes": "Relatively unique 1AB2345 format.", "identification_confidence": "High", "confidence_score": 95 },
            { "state": "Nevada", "vehicle_class": "Passenger", "regex": "^[0-9]{3}[0-9][A-Z][0-9]$", "years_active": "2024-Pres", "constraints": { "exclude_global": ["I", "O", "Q"] }, "notes": "Unique mixed alphanumeric format 123-4A5.", "identification_confidence": "High", "confidence_score": 95 },
            { "state": "Utah", "vehicle_class": "Passenger (Life Elevated)", "regex": "^[A-Z][0-9]{2}[0-9]{3}[A-Z]{2}$", "years_active": "2007-Pres", "constraints": { "exclude_global": ["I", "O", "Q"] }, "notes": "Unique A12 3BC format.", "identification_confidence": "High", "confidence_score": 95 },
            { "state": "Arkansas", "vehicle_class": "Passenger", "regex": "^[A-Z]{3}[0-9]{2}[A-Z]$", "years_active": "2021-Pres", "constraints": { "exclude_global": ["Q"] }, "notes": "The current ABC 12D format is fairly unique.", "identification_confidence": "Medium-High", "confidence_score": 85 },
            { "state": "North Carolina", "vehicle_class": "Passenger", "regex": "^[A-Z]{3}[0-9]{4}$", "years_active": "2010-Pres", "constraints": { "exclude_global": ["G", "I", "O", "Q", "U"], "positional": [{"position": 1, "range": ["A", "M"]}] }, "notes": "Common format, but confidence is raised by the strict positional rule (2nd letter is A-M) and global exclusions.", "identification_confidence": "Medium-High", "confidence_score": 90 },
            { "state": "Pennsylvania", "vehicle_class": "Passenger (Historic)", "regex": "^[A-Z]{3}[0-9]{3}[A-Z]$", "years_active": "2005-2017", "constraints": { "exclude_global": ["I", "O", "Q", "U"] }, "notes": "Historic format from 2005-2017. The ABC-123D pattern is fairly unique.", "identification_confidence": "Medium-High", "confidence_score": 80 },
            { "state": "Arizona", "vehicle_class": "Passenger", "regex": "^[A-Z0-9]{6,7}$", "years_active": "2008-Pres", "constraints": { "exclude_global": ["I", "O", "Q", "U"] }, "notes": "Generic alphanumeric formats, but the I/O/Q/U exclusion rule provides a strong filter.", "identification_confidence": "Medium", "confidence_score": 70 },
            { "state": "Connecticut", "vehicle_class": "Passenger", "regex": "^[A-Z]{2}[0-9]{5}$", "years_active": "2015-Pres", "constraints": {}, "notes": "Format AB-12345 is shared with Illinois but is less common nationally.", "identification_confidence": "Medium", "confidence_score": 65 },
            { "state": "Illinois", "vehicle_class": "Passenger", "regex": "^[A-Z]{2}[0-9]{5}$", "years_active": "2017-Pres", "constraints": {}, "notes": "Format AB-12345 is shared with Connecticut.", "identification_confidence": "Medium", "confidence_score": 65 },
            { "state": "Maine", "vehicle_class": "Passenger", "regex": "^[0-9]{4}[A-Z]{2}$", "years_active": "1999-Pres", "constraints": {}, "notes": "The 1234 AB format is less common than standard 6-character formats.", "identification_confidence": "Medium", "confidence_score": 75 },
            { "state": "New Hampshire", "vehicle_class": "Passenger", "regex": "^[1-9][0-9]{5,6}$", "years_active": "1999-Pres", "constraints": {}, "notes": "All-numeric format, with the 7-digit length being more distinctive.", "identification_confidence": "Medium", "confidence_score": 70 },
            { "state": "New Jersey", "vehicle_class": "Passenger", "regex": "^[A-Z][0-9]{2}[A-Z]{3}$", "years_active": "2014-Pres", "constraints": { "exclude_global": ["I", "O", "Q"] }, "notes": "The A12-BCD format is less common than generic 6-character patterns.", "identification_confidence": "Medium", "confidence_score": 75 },
            { "state": "Vermont", "vehicle_class": "Passenger", "regex": "^[A-Z]{3}[0-9]{3}$", "years_active": "1990-Pres", "constraints": { "exclude_global": ["I", "J", "O", "Q", "U"] }, "notes": "Common format, but the extensive list of excluded letters provides a reasonably strong filter.", "identification_confidence": "Medium", "confidence_score": 60 },
            { "state": "Washington", "vehicle_class": "Passenger", "regex": "^[A-Z]{3}[0-9]{4}$", "years_active": "2010-Pres", "constraints": { "positional": [{"position": 2, "exclude": ["I", "O", "Q"]}] }, "notes": "Common format, but the positional rule for the third letter provides a useful filter.", "identification_confidence": "Medium", "confidence_score": 60 },
            { "state": "Oregon", "vehicle_class": "Passenger", "regex": "^[0-9]{3}[A-Z]{3}$", "years_active": "2004-Pres", "constraints": { "positional": [{"position": 0, "exclude": ["A", "I", "O"]}] }, "notes": "Common format, but confidence is slightly raised by the rule excluding entire letter series (A, I, O).", "identification_confidence": "Low-Medium", "confidence_score": 50 },
            { "state": "Alaska", "vehicle_class": "Passenger", "regex": "^[A-Z]{3}[0-9]{3}$", "years_active": "2010-Pres", "constraints": {}, "notes": "Highly ambiguous ABC-123 format used by numerous states.", "identification_confidence": "Low", "confidence_score": 30 },
            { "state": "Colorado", "vehicle_class": "Passenger", "regex": "^[A-Z]{4}[0-9]{2}$", "years_active": "2018-Pres", "constraints": {}, "notes": "Format ABC-D12 is somewhat ambiguous.", "identification_confidence": "Low", "confidence_score": 40 },
            { "state": "Georgia", "vehicle_class": "Passenger", "regex": "^[A-Z]{3}[0-9]{4}$", "years_active": "2012-Pres", "constraints": { "exclude_global": ["I", "O", "Q"] }, "notes": "Highly ambiguous ABC-1234 format.", "identification_confidence": "Low", "confidence_score": 25 },
            { "state": "Iowa", "vehicle_class": "Passenger", "regex": "^[A-Z]{3}[0-9]{3}$", "years_active": "2012-Pres", "constraints": { "positional": [{"position": 2, "exclude": ["I", "O", "Q"]}] }, "notes": "Highly ambiguous ABC-123 format with a weak positional filter.", "identification_confidence": "Low", "confidence_score": 35 },
            { "state": "Louisiana", "vehicle_class": "Passenger", "regex": "^[0-9]{3}[A-Z]{3}$", "years_active": "2016-Pres", "constraints": {}, "notes": "Highly ambiguous 123-ABC format.", "identification_confidence": "Low", "confidence_score": 30 },
            { "state": "Michigan", "vehicle_class": "Passenger", "regex": "^[A-Z]{3}[0-9]{4}$", "years_active": "2013-Pres", "constraints": { "exclude_global": ["I", "O"] }, "notes": "Highly ambiguous ABC-1234 format.", "identification_confidence": "Low", "confidence_score": 25 },
            { "state": "Minnesota", "vehicle_class": "Passenger", "regex": "^[A-Z]{3}[0-9]{3}$", "years_active": "2017-Pres", "constraints": { "positional": [{"position": 0, "exclude": ["M", "N", "P"]}] }, "notes": "Highly ambiguous ABC-123 format. Excludes the M, N, and P series, which were largely skipped.", "identification_confidence": "Low", "confidence_score": 35 },
            { "state": "New York", "vehicle_class": "Passenger", "regex": "^[A-Z]{3}[0-9]{4}$", "years_active": "2020-Pres", "constraints": { "exclude_global": ["I", "O", "Q"] }, "notes": "Highly ambiguous ABC-1234 format.", "identification_confidence": "Low", "confidence_score": 25 },
            { "state": "Ohio", "vehicle_class": "Passenger", "regex": "^[A-Z]{3}[0-9]{4}$", "years_active": "2021-Pres", "constraints": { "positional": [{"position": 0, "exclude": ["I", "O"]}, {"position": 2, "exclude": ["I", "O"]}] }, "notes": "Highly ambiguous ABC-1234 format with a weak positional filter (I/O only in 2nd position).", "identification_confidence": "Low", "confidence_score": 35 },
            { "state": "Pennsylvania", "vehicle_class": "Passenger", "regex": "^[A-Z]{3}[0-9]{4}$", "years_active": "2017-Pres", "constraints": { "exclude_global": ["I", "O", "Q", "U"], "positional": [{"position": 1, "exclude": ["A", "E"]}] }, "notes": "Highly ambiguous ABC-1234 format. Filters are not strong enough to overcome ambiguity.", "identification_confidence": "Low", "confidence_score": 35 },
            { "state": "South Carolina", "vehicle_class": "Passenger", "regex": "^[A-Z]{3}[0-9]{3}$", "years_active": "2023-Pres", "constraints": {}, "notes": "Highly ambiguous ABC-123 format.", "identification_confidence": "Low", "confidence_score": 30 },
            { "state": "Virginia", "vehicle_class": "Passenger", "regex": "^[A-Z]{3}[0-9]{4}$", "years_active": "2014-Pres", "constraints": {}, "notes": "Highly ambiguous ABC-1234 format.", "identification_confidence": "Low", "confidence_score": 20 },
            { "state": "Wisconsin", "vehicle_class": "Passenger", "regex": "^[A-Z]{3}[0-9]{4}$", "years_active": "2017-Pres", "constraints": { "exclude_global": ["I", "O", "Q"] }, "notes": "Highly ambiguous ABC-1234 format.", "identification_confidence": "Low", "confidence_score": 25 }
        ];
        
        const codedData = {
            alabama_county_codes: Array.from({length: 67}, (_, i) => i + 1),
            hawaii_county_codes: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'J', 'K', 'L', 'M', 'N', 'P', 'R', 'S', 'T', 'W', 'Y', 'Z'],
            idaho_county_codes: ['1A', 'B', 'C', '1B', '2C', 'E', 'F', '1C', 'G', '1G', 'J', 'K', '1L', 'L', '1M', 'M', 'N', 'O', 'P', 'S', '1T', 'T', 'V', 'W', '2L', '1U'],
            montana_county_codes: Array.from({length: 56}, (_, i) => i + 1),
            nebraska_county_codes: Array.from({length: 93}, (_, i) => i + 1),
            south_dakota_county_codes: Array.from({length: 67}, (_, i) => i + 1),
            wyoming_county_codes: Array.from({length: 23}, (_, i) => i + 1),
            west_virginia_month_codes: ['1', '2', '3', '4', '5', '6', '7', '8', '9', 'O', 'N', 'D'],
            massachusetts_month_codes: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'],
            missouri_month_codes: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'J', 'K', 'L', 'M', 'N', 'P', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y']
        };

        // --- DOM Elements ---
        const plateInput = document.getElementById('plateInput');
        const validateBtn = document.getElementById('validateBtn');
        const resultsContainer = document.getElementById('results');
        const csvFileInput = document.getElementById('csvFileInput');
        const batchResultsContainer = document.getElementById('batchResultsContainer');
        const csvOutput = document.getElementById('csvOutput');
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');
        const localStateSelect = document.getElementById('localStateSelect');

        // --- Music Setup ---
        let musicInitialized = false;
        let backgroundMusic;

        /**
         * Initializes the Audio object for background music.
         */
        function setupMusic() {
            if (musicInitialized) return;
            // Assumes gecs.mp3 is in the same directory as the HTML file
            backgroundMusic = new Audio('gecs.mp3'); 
            backgroundMusic.loop = true;
            musicInitialized = true;
        }

        /**
         * Populates the local state dropdown menu.
         */
        function populateStateSelector() {
            const states = [...new Set(rules.map(rule => rule.state))].sort();
            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                localStateSelect.appendChild(option);
            });
        }
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            populateStateSelector();

            // Music toggle button is removed from HTML, so no listener is needed.

            validateBtn.addEventListener('click', handleValidation);
            plateInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleValidation();
            });
            csvFileInput.addEventListener('change', handleFileUpload);
            downloadCsvBtn.addEventListener('click', handleDownload);
        });

        /**
         * Main handler for the validation process.
         */
        function handleValidation() {
            // Start music on interaction, as per the artistic requirement
            if (!musicInitialized) {
                setupMusic();
            }
            if (backgroundMusic && backgroundMusic.paused) {
                backgroundMusic.play().catch(e => console.error("Audio playback failed.", e));
            }

            const plateStr = plateInput.value;
            if (!plateStr) {
                displayError("Please type in a plate number first!~");
                return;
            }
            const preprocessedPlate = plateStr.replace(/[^A-Z0-9]/gi, '').toUpperCase();
            const localState = localStateSelect.value;
            const matches = findMatches(preprocessedPlate, localState);
            renderResults(matches, preprocessedPlate);
        }

        /**
         * Finds all matching state rules for a given plate string.
         * @param {string} plate - The preprocessed license plate string.
         * @param {string} localState - The state selected for local bias.
         * @returns {Array} - An array of matching rule objects.
         */
        function findMatches(plate, localState) {
            if (plate.length < 3 || plate.length > 8) return []; 
            
            const potentialMatches = [];
            const LOCAL_BIAS_BOOST = 40; // The confidence score boost for the local state

            for (const rule of rules) {
                const regex = new RegExp(rule.regex);
                if (!regex.test(plate)) continue;

                let isMatch = true;
                if (rule.constraints.exclude_global) {
                    for (const char of rule.constraints.exclude_global) {
                        if (plate.includes(char)) { isMatch = false; break; }
                    }
                }
                if (!isMatch) continue;

                if (rule.constraints.positional) {
                    for (const posRule of rule.constraints.positional) {
                        const charAtIndex = plate.charAt(posRule.position);
                        if (posRule.exclude && posRule.exclude.includes(charAtIndex)) { isMatch = false; break; }
                        if (posRule.include && !posRule.include.includes(charAtIndex)) { isMatch = false; break; }
                        if (posRule.range && (charAtIndex < posRule.range[0] || charAtIndex > posRule.range[1])) { isMatch = false; break; }
                    }
                }
                if (!isMatch) continue;

                if (rule.constraints.coded_info) {
                    const info = rule.constraints.coded_info;
                    let code = (info.positions[0] === -1) ? plate.slice(-1) : plate.substring(info.positions[0], info.positions[1]);

                    if (info.type === 'County') {
                        const countyCodeMatch = plate.match(/^[0-9]{1,2}/);
                        if (countyCodeMatch) {
                            if (!codedData[info.mapping_key].includes(parseInt(countyCodeMatch[0]))) isMatch = false;
                        } else { isMatch = false; }
                    } else if (info.type === 'Month') {
                        if (!codedData[info.mapping_key].includes(code)) isMatch = false;
                    } else if(info.type === 'Prefix') {
                        if (!codedData[info.mapping_key].some(prefix => plate.startsWith(prefix))) isMatch = false;
                    }
                }
                if (!isMatch) continue;

                const matchResult = { ...rule };

                if (localState && matchResult.state === localState) {
                    matchResult.confidence_score += LOCAL_BIAS_BOOST;
                }

                potentialMatches.push(matchResult);
            }
            return potentialMatches;
        }

        /**
         * Renders the validation results to the DOM.
         * @param {Array} matches - An array of matching rule objects.
         * @param {string} originalPlate - The original user input.
         */
        function renderResults(matches, originalPlate) {
            resultsContainer.innerHTML = ''; 

            if (matches.length === 0) {
                displayError(`Couldn't find any matches for "${originalPlate}"... Sorry!`);
                return;
            }

            const title = document.createElement('h2');
            title.className = "title-h2 text-shadow text-center";
            title.textContent = `Results for "${originalPlate}"!`;
            resultsContainer.appendChild(title);

            matches.sort((a, b) => b.confidence_score - a.confidence_score);
            matches.forEach(match => resultsContainer.appendChild(createResultCard(match)));
        }

        /**
         * Creates an HTML card element for a single match result.
         * @param {object} match - A single matching rule object.
         * @returns {HTMLElement} - The created card element.
         */
        function createResultCard(match) {
            const card = document.createElement('div');
            card.className = 'result-card animate-fade-in';
            
            const confidenceLevel = match.identification_confidence.toLowerCase();
            let bgColorClass = 'bg-low'; // Default to low
            if (confidenceLevel === 'high') bgColorClass = 'bg-high';
            else if (confidenceLevel === 'medium-high') bgColorClass = 'bg-medium-high';
            else if (confidenceLevel === 'medium') bgColorClass = 'bg-medium';
            else if (confidenceLevel === 'low-medium') bgColorClass = 'bg-low-medium';

            const displayScore = Math.min(100, Math.round(match.confidence_score));

            card.innerHTML = `
                <div class="card-header">
                    <span class="card-state-name">${match.state} <span class="card-vehicle-class">(${match.vehicle_class})</span></span>
                    <span class="card-confidence-badge ${bgColorClass}">
                        ${displayScore}% Match!
                    </span>
                </div>
                <p class="card-notes">${match.notes}</p>
            `;
            return card;
        }

        /**
         * Displays an error message in the results container.
         * @param {string} message - The error message to display.
         */
        function displayError(message) {
            resultsContainer.innerHTML = `<div class="error-message">${message}</div>`;
        }

        /**
         * Handles the CSV file upload and processing.
         * @param {Event} event - The file input change event.
         */
        function handleFileUpload(event) {
            // Start music on interaction, as per the artistic requirement
            if (!musicInitialized) {
                setupMusic();
            }
            if (backgroundMusic && backgroundMusic.paused) {
                backgroundMusic.play().catch(e => console.error("Audio playback failed.", e));
            }

            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => processCsvData(e.target.result);
            reader.readAsText(file);
        }

        /**
         * Processes the text content of a CSV file.
         * @param {string} csvContent - The string content of the CSV file.
         */
        function processCsvData(csvContent) {
            const lines = csvContent.split(/\r?\n/).filter(line => line.trim() !== '');
            const header = ['plate number', 'isplate?[1/0]', 'result1', 'result2', 'result3', 'result4', 'result5'];
            const outputRows = [header];
            const localState = localStateSelect.value;

            for (const line of lines) {
                const plate = line.trim();
                if (!plate) continue;
                const preprocessedPlate = plate.replace(/[^A-Z0-9]/gi, '').toUpperCase();
                const matches = findMatches(preprocessedPlate, localState);

                const row = [plate];
                if (matches.length > 0) {
                    row.push(1); // isplate = 1
                    matches.sort((a, b) => b.confidence_score - a.confidence_score);
                    for (let i = 0; i < 5; i++) {
                        row.push(matches[i] ? `"${Math.min(100, Math.round(matches[i].confidence_score))} - ${matches[i].state}"` : '');
                    }
                } else {
                    row.push(0); // isplate = 0
                    for (let i = 0; i < 5; i++) row.push('');
                }
                outputRows.push(row);
            }
            
            const outputCsv = outputRows.map(row => row.join(',')).join('\n');
            csvOutput.value = outputCsv;
            batchResultsContainer.style.display = 'flex';
        }

        /**
         * Handles downloading the processed CSV results.
         */
        function handleDownload() {
            const csvContent = csvOutput.value;
            if (!csvContent) return;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "plate_validation_results.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
</html>
