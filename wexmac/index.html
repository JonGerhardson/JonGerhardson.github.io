<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WEXMAC Task Orders Dashboard - Advanced Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --danger: #dc2626;
            --success: #059669;
            --warning: #d97706;
            --info: #0891b2;
            --bg-primary: #ffffff;
            --bg-secondary: #f3f4f6;
            --bg-tertiary: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border: #d1d5db;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
        }
        .container { max-width: 1800px; margin: 0 auto; padding: 20px; }
        
        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
        }
        header .container { display: flex; justify-content: space-between; align-items: center; }
        h1 { font-size: 32px; margin-bottom: 5px; }
        .subtitle { opacity: 0.9; font-size: 14px; }
        .header-actions { display: flex; gap: 10px; }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background: white; color: var(--primary); }
        .btn-primary:hover { background: var(--bg-secondary); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background: var(--border); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }
        .stat-card.danger::before { background: var(--danger); }
        .stat-card.success::before { background: var(--success); }
        .stat-card.warning::before { background: var(--warning); }
        .stat-card.info::before { background: var(--info); }
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
        }
        .stat-change {
            font-size: 12px;
            margin-top: 8px;
            color: var(--text-secondary);
        }
        
        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-card {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        /* Controls */
        .controls-card {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        .controls-title {
            font-size: 18px;
            font-weight: 600;
        }
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .control-group { display: flex; flex-direction: column; }
        .control-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
        }
        input, select {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
        }
        .date-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .date-range input { flex: 1; }
        
        /* Active Filters */
        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }
        .filter-tag {
            background: var(--bg-secondary);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .filter-tag button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 14px;
            padding: 0;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            background: var(--bg-primary);
            padding: 5px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        .tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            border-radius: 6px;
            transition: all 0.2s;
        }
        .tab:hover { background: var(--bg-secondary); }
        .tab.active {
            background: var(--primary);
            color: white;
        }
        
        /* Table */
        .table-card {
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        .table-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-title { font-size: 18px; font-weight: 600; }
        .table-actions { display: flex; gap: 10px; }
        .table-container { overflow-x: auto; max-height: 600px; overflow-y: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th {
            background: var(--bg-secondary);
            padding: 14px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 11px;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }
        th:hover { background: var(--bg-tertiary); }
        th .sort-icon { margin-left: 5px; opacity: 0.5; }
        th.sorted .sort-icon { opacity: 1; }
td {
padding: 14px;
border-top: 1px solid var(--border);
vertical-align: top;
}
tr.description-row td {
padding: 0;
background: var(--bg-secondary);
border-top: none;
}
.description-content {
padding: 16px;
background: var(--bg-secondary);
border-left: 4px solid var(--primary);
margin: 0 14px 14px 14px;
border-radius: 0 8px 8px 0;
}
.description-content pre {
white-space: pre-wrap;
word-wrap: break-word;
margin: 0;
font-family: inherit;
line-height: 1.6;
color: var(--text-primary);
}
.description-toggle {
background: var(--bg-tertiary);
border: 1px solid var(--border);
cursor: pointer;
padding: 4px 12px;
border-radius: 4px;
font-size: 11px;
font-weight: 600;
color: var(--primary);
transition: all 0.2s;
}
.description-toggle:hover {
background: var(--primary);
color: white;
}
        tr:hover { background: var(--bg-secondary); }
        tr.clickable { cursor: pointer; }
        tr.clickable:hover { background: var(--bg-tertiary); }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-success { background: #d1fae5; color: var(--success); }
        .badge-danger { background: #fee2e2; color: var(--danger); }
        .badge-warning { background: #fef3c7; color: var(--warning); }
        .badge-info { background: #cffafe; color: var(--info); }
        .badge-primary { background: #dbeafe; color: var(--primary); }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-top: 1px solid var(--border);
        }
        .page-info { color: var(--text-secondary); font-size: 14px; }
        .page-controls { display: flex; gap: 5px; }
        .page-btn {
            padding: 8px 14px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            cursor: pointer;
            border-radius: 6px;
            font-size: 13px;
        }
        .page-btn:hover:not(:disabled) { background: var(--bg-secondary); }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--bg-primary);
            border-radius: 12px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }
        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title { font-size: 20px; font-weight: 600; }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(90vh - 140px);
        }
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .detail-item {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 8px;
        }
        .detail-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 6px;
        }
        .detail-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            word-break: break-word;
        }
        .detail-value.large {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }
        
        /* Contractor Panel */
        .contractor-panel {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .contractor-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        /* Export Menu */
        .export-menu {
            position: relative;
        }
        .export-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            display: none;
            min-width: 180px;
            z-index: 100;
        }
        .export-dropdown.active { display: block; }
        .export-option {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .export-option:hover { background: var(--bg-secondary); }
        .export-option:first-child { border-radius: 8px 8px 0 0; }
        .export-option:last-child { border-radius: 0 0 8px 8px; }
        
        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px;
            color: var(--text-secondary);
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Error State */
        .error-state {
            text-align: center;
            padding: 60px;
            color: var(--danger);
        }
        .error-state h2 { margin-bottom: 15px; }
        .error-state code {
            background: var(--bg-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            header .container { flex-direction: column; text-align: center; gap: 20px; }
            .stats-grid { grid-template-columns: 1fr; }
            .charts-grid { grid-template-columns: 1fr; }
            .controls-grid { grid-template-columns: 1fr; }
            .table-header { flex-direction: column; gap: 15px; }
            .tabs { flex-wrap: wrap; }
        }
        
        /* Utility */
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .text-muted { color: var(--text-secondary); }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
        .mb-0 { margin-bottom: 0; }
        .mt-20 { margin-top: 20px; }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div>
                <h1>WEXMAC Task Orders Dashboard</h1>
                <p class="subtitle">Explore task orders issued under the Naval Supply Systems Command
 <a href="https://sam.gov/workspace/contract/opp/fc38d5a3e2b049f6ab71ef32b113e003/view" target="_blank" style="color: white; text-decoration: underline;">WEXMAC 2.2 TITUS</a> contract vehicle, updated daily.</p> 
                <p class="subtitle">Made by  <a href="https://jongerhardson.github.io" target="_blank" style="color: white; text-decoration: underline;">Jonathan Gerhardson</a> | jon.gerhardson@proton.me</p>
            </div>
            <div class="header-actions">
                <div class="export-menu">
                    <button class="btn btn-primary" onclick="toggleExportMenu()">
                        <span>üì• Export</span>
                    </button>
                    <div class="export-dropdown" id="exportMenu">
                        <div class="export-option" onclick="exportCSV()">üìÑ Export to CSV</div>
                        <div class="export-option" onclick="exportJSON()">üìã Export to JSON</div>
                        <div class="export-option" onclick="exportExcel()">üìä Export to Excel</div>
                        <div class="export-option" onclick="window.print()">üñ®Ô∏è Print Report</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Stats Overview -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-label">Total IDVs</div>
                <div class="stat-value" id="statTotalIdvs">-</div>
                <div class="stat-change">Contract vehicles in system</div>
            </div>
            <div class="stat-card success">
                <div class="stat-label">Active IDVs</div>
                <div class="stat-value" id="statActiveIdvs">-</div>
                <div class="stat-change">With task orders issued</div>
            </div>
            <div class="stat-card info">
                <div class="stat-label">Total Task Orders</div>
                <div class="stat-value" id="statTotalTOs">-</div>
                <div class="stat-change">All time</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-label">Total Obligated</div>
                <div class="stat-value" id="statTotalObligated">-</div>
                <div class="stat-change">FY2025-2026</div>
            </div>
            <div class="stat-card danger">
                <div class="stat-label">Avg Task Order</div>
                <div class="stat-value" id="statAvgTO">-</div>
                <div class="stat-change">Per award</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Top Contractor</div>
                <div class="stat-value" style="font-size: 18px;" id="statTopContractor">-</div>
                <div class="stat-change" id="statTopContractorAmt">-</div>
            </div>
            <div class="stat-card info">
                <div class="stat-label">New This Week</div>
                <div class="stat-value" id="statNewThisWeek">-</div>
                <div class="stat-change">Task orders first seen in last 7 days</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-title">Obligations by Month</div>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">Top 10 Contractors by Value</div>
                <div class="chart-container">
                    <canvas id="contractorChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">Task Orders by Agency</div>
                <div class="chart-container">
                    <canvas id="agencyChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">Contract Value Distribution</div>
                <div class="chart-container">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="controls-card">
            <div class="controls-header">
                <div class="controls-title">üîç Filters & Search</div>
                <button class="btn btn-secondary btn-sm" onclick="clearAllFilters()">Clear All</button>
            </div>
            <div class="controls-grid">
                <div class="control-group">
                    <label>Search (PIID, Vendor, Description)</label>
                    <input type="text" id="searchInput" placeholder="Type to search..." oninput="debouncedFilter()">
                </div>
                <div class="control-group">
                    <label>Vendor / Contractor</label>
                    <select id="vendorFilter" onchange="applyFilters()">
                        <option value="">All Vendors</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Contracting Agency</label>
                    <select id="agencyFilter" onchange="applyFilters()">
                        <option value="">All Agencies</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Contracting Office</label>
                    <select id="officeFilter" onchange="applyFilters()">
                        <option value="">All Offices</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>State / Location</label>
                    <select id="stateFilter" onchange="applyFilters()">
                        <option value="">All Locations</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Business Size</label>
                    <select id="sizeFilter" onchange="applyFilters()">
                        <option value="">All Sizes</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Set Aside</label>
                    <select id="setAsideFilter" onchange="applyFilters()">
                        <option value="">All Types</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Min Amount ($)</label>
                    <input type="number" id="minAmountFilter" placeholder="0" oninput="debouncedFilter()">
                </div>
                <div class="control-group">
                    <label>Max Amount ($)</label>
                    <input type="number" id="maxAmountFilter" placeholder="No limit" oninput="debouncedFilter()">
                </div>
                <div class="control-group">
                    <label>Date Range</label>
                    <div class="date-range">
                        <input type="date" id="dateFrom" onchange="applyFilters()">
                        <span>to</span>
                        <input type="date" id="dateTo" onchange="applyFilters()">
                    </div>
                </div>
            </div>
            <div class="active-filters" id="activeFilters"></div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('taskorders')">üìã Task Orders</button>
            <button class="tab" onclick="switchTab('contractors')">üè¢ Contractors</button>
            <button class="tab" onclick="switchTab('agencies')">üèõÔ∏è Agencies</button>
            <button class="tab" onclick="switchTab('analytics')">üìä Analytics</button>
        </div>

        <!-- Task Orders Table -->
        <div id="taskOrdersTab" class="tab-content">
            <div class="table-card">
                <div class="table-header">
                    <div class="table-title">Task Orders <span class="text-muted" id="resultCount"></span></div>
                    <div class="table-actions">
                        <select id="pageSize" onchange="changePageSize()">
                            <option value="25">25 per page</option>
                            <option value="50">50 per page</option>
                            <option value="100">100 per page</option>
                            <option value="all">Show All</option>
                        </select>
                    </div>
                </div>
                <div class="table-container">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('piid')">PIID <span class="sort-icon">‚Üï</span></th>
                                <th onclick="sortTable('vendor_name')">Vendor <span class="sort-icon">‚Üï</span></th>
                                <th onclick="sortTable('total_obligated_amount')">Total Obligated <span class="sort-icon">‚Üï</span></th>
                                <th onclick="sortTable('signed_date')">Signed Date <span class="sort-icon">‚Üï</span></th>
                                <th onclick="sortTable('first_seen')">First Seen <span class="sort-icon">‚Üï</span></th>
                                <th onclick="sortTable('contracting_agency')">Agency <span class="sort-icon">‚Üï</span></th>
                                <th>Description</th>
                                <th onclick="sortTable('idv_piid')">Parent IDV <span class="sort-icon">‚Üï</span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr><td colspan="9" class="loading"><div class="spinner"></div>Loading data...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="pagination"></div>
            </div>
        </div>

        <!-- Contractors Tab -->
        <div id="contractorsTab" class="tab-content" style="display: none;">
            <div class="table-card">
                <div class="table-header">
                    <div class="table-title">Contractors Summary</div>
                </div>
                <div class="table-container">
                    <table id="contractorTable">
                        <thead>
                            <tr>
                                <th>Contractor</th>
                                <th>UEI</th>
                                <th>Location</th>
                                <th>Task Orders</th>
                                <th>Total Obligated</th>
                                <th>Avg Award</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="contractorTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Agencies Tab -->
        <div id="agenciesTab" class="tab-content" style="display: none;">
            <div class="table-card">
                <div class="table-header">
                    <div class="table-title">Agency Breakdown</div>
                </div>
                <div class="table-container">
                    <table id="agencyTable">
                        <thead>
                            <tr>
                                <th>Agency</th>
                                <th>Task Orders</th>
                                <th>Total Obligated</th>
                                <th>Avg Award</th>
                                <th>% of Total</th>
                            </tr>
                        </thead>
                        <tbody id="agencyTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analyticsTab" class="tab-content" style="display: none;">
            <div class="charts-grid" style="grid-template-columns: 1fr;">
                <div class="chart-card">
                    <div class="chart-title">Geographic Distribution</div>
                    <div class="table-container" style="max-height: 400px;">
                        <table id="geoTable">
                            <thead>
                                <tr>
                                    <th>State/Location</th>
                                    <th>Task Orders</th>
                                    <th>Total Value</th>
                                    <th>Contractors</th>
                                </tr>
                            </thead>
                            <tbody id="geoTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal-overlay" id="detailModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Task Order Details</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <script>
        // Global state
        let rawData = {};
        let allTaskOrders = [];
        let filteredTaskOrders = [];
        let currentPage = 1;
        let pageSize = 25;
        let sortColumn = 'total_obligated_amount';
        let sortDirection = 'desc';
        let charts = {};
        let filterTimeout;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
        });

// Load data
function loadData() {
console.log('Starting to load wexmac_task_orders_fpds.json...');
fetch('data/wexmac_task_orders_fpds.json')
.then(r => {
console.log('Fetch response:', r.status, r.statusText);
if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
return r.json();
})
.then(data => {
console.log('Data loaded successfully. IDVs count:', data.idvs ? data.idvs.length : 0);
rawData = data;
processData();
console.log('Processed task orders:', allTaskOrders.length);
updateStats();
populateFilters();
applyFilters();
try {
initCharts();
} catch (e) {
console.error('Chart error:', e);
}
renderContractorTable();
renderAgencyTable();
renderGeoTable();
console.log('Dashboard initialization complete');
})
.catch(err => {
console.error('Failed to load data:', err);
document.getElementById('tableBody').innerHTML = `
<tr><td colspan="9" class="error-state">
<h2>‚ö†Ô∏è Error Loading Data</h2>
<p>${err.message}</p>
<p style="margin-top: 15px;">Current URL: ${window.location.href}</p>
<p style="margin-top: 10px;">If opening directly (file://), you must use a web server:</p>
<code>python -m http.server 8000</code>
</td></tr>
`;
});
}

        // Process and flatten data
        function processData() {
            allTaskOrders = [];
            if (!rawData.idvs || !Array.isArray(rawData.idvs)) return;

            rawData.idvs.forEach(idv => {
                if (idv.task_orders && Array.isArray(idv.task_orders)) {
                    idv.task_orders.forEach(to => {
                        allTaskOrders.push({
                            ...to,
                            idv_piid: idv.idv_piid,
                            idv_piid_dashes: idv.idv_piid_dashes,
                            contractor_name: idv.contractor_name,
                            contractor_uei: idv.contractor_uei,
                            contractor_location: idv.contractor_location
                        });
                    });
                }
            });

            filteredTaskOrders = [...allTaskOrders];
        }

        // Update statistics
        function updateStats() {
            const meta = rawData.metadata || {};
            
            // Calculate derived stats
            const activeIdvs = new Set(allTaskOrders.map(to => to.idv_piid)).size;
const totalObligated = allTaskOrders.reduce((sum, to) => sum + (to.total_obligated_amount || 0), 0);
const avgTo = allTaskOrders.length > 0 ? totalObligated / allTaskOrders.length : 0;

// Find top contractor
const contractorTotals = {};
allTaskOrders.forEach(to => {
const name = to.contractor_name || 'Unknown';
contractorTotals[name] = (contractorTotals[name] || 0) + (to.total_obligated_amount || 0);
            });
            const topContractor = Object.entries(contractorTotals)
                .sort((a, b) => b[1] - a[1])[0] || ['None', 0];

            // Count task orders first seen in last 7 days
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const newThisWeek = allTaskOrders.filter(to => {
                if (!to.first_seen) return false;
                const firstSeenDate = new Date(to.first_seen);
                return firstSeenDate >= oneWeekAgo;
            }).length;

            document.getElementById('statTotalIdvs').textContent = meta.idv_count || 0;
            document.getElementById('statActiveIdvs').textContent = activeIdvs;
            document.getElementById('statTotalTOs').textContent = allTaskOrders.length;
            document.getElementById('statTotalObligated').textContent = formatCurrency(totalObligated);
            document.getElementById('statAvgTO').textContent = formatCurrency(avgTo);
            document.getElementById('statTopContractor').textContent = topContractor[0];
            document.getElementById('statTopContractorAmt').textContent = formatCurrency(topContractor[1]);
            document.getElementById('statNewThisWeek').textContent = newThisWeek;
        }

        // Populate filter dropdowns
        function populateFilters() {
            const vendors = [...new Set(allTaskOrders.map(to => to.vendor_name).filter(Boolean))].sort();
            const agencies = [...new Set(allTaskOrders.map(to => to.contracting_agency).filter(Boolean))].sort();
            const offices = [...new Set(allTaskOrders.map(to => to.contracting_office).filter(Boolean))].sort();
            const states = [...new Set(allTaskOrders.map(to => to.pop_state || to.vendor_state).filter(Boolean))].sort();
            const sizes = [...new Set(allTaskOrders.map(to => to.business_size).filter(Boolean))].sort();
            const setAsides = [...new Set(allTaskOrders.map(to => to.set_aside).filter(Boolean))].sort();

            populateSelect('vendorFilter', vendors);
            populateSelect('agencyFilter', agencies);
            populateSelect('officeFilter', offices);
            populateSelect('stateFilter', states);
            populateSelect('sizeFilter', sizes);
            populateSelect('setAsideFilter', setAsides);
        }

        function populateSelect(id, options) {
            const select = document.getElementById(id);
            const currentValue = select.value;
            select.innerHTML = '<option value="">All</option>';
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
            });
            select.value = currentValue;
        }

        // Apply filters
        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const vendor = document.getElementById('vendorFilter').value;
            const agency = document.getElementById('agencyFilter').value;
            const office = document.getElementById('officeFilter').value;
            const state = document.getElementById('stateFilter').value;
            const size = document.getElementById('sizeFilter').value;
            const setAside = document.getElementById('setAsideFilter').value;
            const minAmt = parseFloat(document.getElementById('minAmountFilter').value) || 0;
            const maxAmt = parseFloat(document.getElementById('maxAmountFilter').value) || Infinity;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            filteredTaskOrders = allTaskOrders.filter(to => {
                if (search && !(
                    (to.piid || '').toLowerCase().includes(search) ||
                    (to.vendor_name || '').toLowerCase().includes(search) ||
                    (to.description || '').toLowerCase().includes(search) ||
                    (to.contractor_name || '').toLowerCase().includes(search)
                )) return false;

                if (vendor && to.vendor_name !== vendor) return false;
                if (agency && to.contracting_agency !== agency) return false;
                if (office && to.contracting_office !== office) return false;
                if (state && (to.pop_state !== state && to.vendor_state !== state)) return false;
                if (size && to.business_size !== size) return false;
                if (setAside && to.set_aside !== setAside) return false;
if ((to.total_obligated_amount || 0) < minAmt) return false;
if ((to.total_obligated_amount || 0) > maxAmt) return false;

                if (dateFrom || dateTo) {
                    const signedDate = to.signed_date ? new Date(to.signed_date) : null;
                    if (signedDate) {
                        if (dateFrom && signedDate < new Date(dateFrom)) return false;
                        if (dateTo && signedDate > new Date(dateTo + 'T23:59:59')) return false;
                    }
                }

                return true;
            });

            currentPage = 1;
            updateActiveFilters();
            renderTable();
            updateResultCount();
        }

        function debouncedFilter() {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(applyFilters, 300);
        }

        function updateActiveFilters() {
            const filters = [];
            const addFilter = (label, value, clearFn) => {
                if (value) filters.push({ label, value, clear: clearFn });
            };

            addFilter('Search', document.getElementById('searchInput').value, () => {
                document.getElementById('searchInput').value = '';
                applyFilters();
            });
            addFilter('Vendor', document.getElementById('vendorFilter').value, () => {
                document.getElementById('vendorFilter').value = '';
                applyFilters();
            });
            addFilter('Agency', document.getElementById('agencyFilter').value, () => {
                document.getElementById('agencyFilter').value = '';
                applyFilters();
            });

            const container = document.getElementById('activeFilters');
            if (filters.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = '<span style="font-size: 12px; color: var(--text-secondary);">Active filters:</span> ' +
                filters.map(f => `
                    <span class="filter-tag">
                        ${f.label}: ${f.value.substring(0, 30)}${f.value.length > 30 ? '...' : ''}
                        <button onclick="(${f.clear.toString()})()">&times;</button>
                    </span>
                `).join('');
        }

        function clearAllFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('vendorFilter').value = '';
            document.getElementById('agencyFilter').value = '';
            document.getElementById('officeFilter').value = '';
            document.getElementById('stateFilter').value = '';
            document.getElementById('sizeFilter').value = '';
            document.getElementById('setAsideFilter').value = '';
            document.getElementById('minAmountFilter').value = '';
            document.getElementById('maxAmountFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            applyFilters();
        }

        // Sorting
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'desc';
            }

            filteredTaskOrders.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';

                if (typeof aVal === 'number' && typeof bVal === 'number') {
                    return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                }

                aVal = String(aVal).toLowerCase();
                bVal = String(bVal).toLowerCase();
                return sortDirection === 'asc' 
                    ? aVal.localeCompare(bVal) 
                    : bVal.localeCompare(aVal);
            });

            renderTable();
        }

// Render table
function renderTable() {
const tbody = document.getElementById('tableBody');

if (filteredTaskOrders.length === 0) {
tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: var(--text-secondary);">No task orders found matching the filters.</td></tr>';
renderPagination();
return;
}

const start = (currentPage - 1) * pageSize;
const end = pageSize === 'all' ? filteredTaskOrders.length : start + pageSize;
const pageData = filteredTaskOrders.slice(start, end);

tbody.innerHTML = pageData.map(to => {
const amt = to.total_obligated_amount || 0;
const badgeClass = amt > 1000000 ? 'badge-success' : amt > 0 ? 'badge-info' : 'badge-danger';
const descId = `desc-${to.piid.replace(/[^a-zA-Z0-9]/g, '-')}`;
const description = to.description || 'N/A';
const isLong = description.length > 100;

return `
<tr class="clickable main-row" data-piid="${to.piid}">
<td onclick="showDetail('${to.piid}')"><code>${to.piid}</code></td>
<td onclick="showDetail('${to.piid}')">${to.vendor_name || 'N/A'}</td>
<td onclick="showDetail('${to.piid}')"><span class="badge ${badgeClass}">${formatCurrency(amt)}</span></td>
<td onclick="showDetail('${to.piid}')">${formatDate(to.signed_date)}</td>
<td onclick="showDetail('${to.piid}')">${formatDate(to.first_seen)}</td>
<td onclick="showDetail('${to.piid}')">${to.contracting_agency || 'N/A'}</td>
<td style="max-width: 400px;">
<div id="${descId}-short" style="display: ${isLong ? 'block' : 'none'};">
${escapeHtml(description.substring(0, 100))}${isLong ? '...' : ''}
<button class="btn btn-sm" style="padding: 2px 8px; font-size: 11px; margin-left: 8px;" onclick="event.stopPropagation(); toggleDescription('${descId}', true)">Show more</button>
</div>
<div id="${descId}-full" style="display: ${isLong ? 'none' : 'block'}; white-space: pre-wrap; line-height: 1.5;">
${escapeHtml(description)}
${isLong ? `<button class="btn btn-sm" style="padding: 2px 8px; font-size: 11px; margin-top: 8px; display: block;" onclick="event.stopPropagation(); toggleDescription('${descId}', false)">Show less</button>` : ''}
</div>
</td>
<td onclick="showDetail('${to.piid}')"><code>${to.idv_piid}</code></td>
<td>
<button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); showDetail('${to.piid}')">
View
</button>
                        </td>
                    </tr>
                `;
            }).join('');

            renderPagination();
        }

        function renderPagination() {
            if (pageSize === 'all') {
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            const totalPages = Math.ceil(filteredTaskOrders.length / pageSize);
            let html = `<div class="page-info">Showing ${(currentPage - 1) * pageSize + 1} - ${Math.min(currentPage * pageSize, filteredTaskOrders.length)} of ${filteredTaskOrders.length}</div>`;
            
            html += '<div class="page-controls">';
            html += `<button class="page-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>`;
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += `<span style="padding: 8px;">...</span>`;
                }
            }
            
            html += `<button class="page-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;
            html += '</div>';

            document.getElementById('pagination').innerHTML = html;
        }

        function changePage(page) {
            currentPage = page;
            renderTable();
        }

        function changePageSize() {
            const select = document.getElementById('pageSize');
            pageSize = select.value === 'all' ? 'all' : parseInt(select.value);
            currentPage = 1;
            renderTable();
        }

        function updateResultCount() {
            document.getElementById('resultCount').textContent = `(${filteredTaskOrders.length} results)`;
        }

        // Contractor table - includes all 110 IDV holders, even those with 0 task orders
        function renderContractorTable() {
            const contractors = {};

            // Seed from rawData.idvs so every IDV holder appears
            if (rawData.idvs && Array.isArray(rawData.idvs)) {
                rawData.idvs.forEach(idv => {
                    const name = idv.contractor_name || 'Unknown';
                    if (!contractors[name]) {
                        contractors[name] = {
                            name,
                            uei: idv.contractor_uei || '',
                            location: idv.contractor_location || '',
                            idv_piid: idv.idv_piid || '',
                            count: 0,
                            total: 0
                        };
                    }
                });
            }

            // Aggregate task order values
            allTaskOrders.forEach(to => {
                const name = to.contractor_name || 'Unknown';
                if (!contractors[name]) {
                    contractors[name] = {
                        name,
                        uei: to.contractor_uei || '',
                        location: to.contractor_location || '',
                        idv_piid: to.idv_piid || '',
                        count: 0,
                        total: 0
                    };
                }
                contractors[name].count++;
                contractors[name].total += to.total_obligated_amount || 0;
            });

            const sorted = Object.values(contractors).sort((a, b) => b.total - a.total);

            document.getElementById('contractorTableBody').innerHTML = sorted.map(c => `
                <tr>
                    <td><strong>${c.name}</strong></td>
                    <td><code>${c.uei || 'N/A'}</code></td>
                    <td>${c.location || 'N/A'}</td>
                    <td>${c.count}</td>
                    <td>${formatCurrency(c.total)}</td>
                    <td>${formatCurrency(c.count > 0 ? c.total / c.count : 0)}</td>
                    <td>
                        ${c.count > 0 ? `<button class="btn btn-secondary btn-sm" onclick="filterByContractor('${c.name.replace(/'/g, "\\'")}')">Filter</button>` : '<span class="text-muted">No TOs</span>'}
                    </td>
                </tr>
            `).join('');
        }

        // Agency table
        function renderAgencyTable() {
            const agencies = {};
            allTaskOrders.forEach(to => {
                const agency = to.contracting_agency || 'Unknown';
                if (!agencies[agency]) {
                    agencies[agency] = { name: agency, count: 0, total: 0 };
                }
agencies[agency].count++;
agencies[agency].total += to.total_obligated_amount || 0;
});

const totalValue = Object.values(agencies).reduce((sum, a) => sum + a.total, 0);
            const sorted = Object.values(agencies).sort((a, b) => b.total - a.total);

            document.getElementById('agencyTableBody').innerHTML = sorted.map(a => `
                <tr>
                    <td><strong>${a.name}</strong></td>
                    <td>${a.count}</td>
                    <td>${formatCurrency(a.total)}</td>
                    <td>${formatCurrency(a.count > 0 ? a.total / a.count : 0)}</td>
                    <td>${((a.total / totalValue) * 100).toFixed(1)}%</td>
                </tr>
            `).join('');
        }

        // Geographic table
        function renderGeoTable() {
            const locations = {};
            allTaskOrders.forEach(to => {
                const loc = to.pop_state || to.vendor_state || 'Unknown';
                if (!locations[loc]) {
                    locations[loc] = { state: loc, count: 0, total: 0, contractors: new Set() };
                }
locations[loc].count++;
locations[loc].total += to.total_obligated_amount || 0;
locations[loc].contractors.add(to.contractor_name);
});

            const sorted = Object.values(locations).sort((a, b) => b.total - a.total);

            document.getElementById('geoTableBody').innerHTML = sorted.map(l => `
                <tr>
                    <td><strong>${l.state}</strong></td>
                    <td>${l.count}</td>
                    <td>${formatCurrency(l.total)}</td>
                    <td>${l.contractors.size}</td>
                </tr>
            `).join('');
        }

// Initialize charts
function initCharts() {
// Monthly chart
const monthlyData = {};
allTaskOrders.forEach(to => {
if (to.signed_date) {
const month = to.signed_date.substring(0, 7);
monthlyData[month] = (monthlyData[month] || 0) + (to.total_obligated_amount || 0);
}
});

            const months = Object.keys(monthlyData).sort();
            charts.monthly = new Chart(document.getElementById('monthlyChart'), {
                type: 'bar',
                data: {
                    labels: months.map(m => {
                        const [year, month] = m.split('-');
                        return `${month}/${year}`;
                    }),
                    datasets: [{
                        label: 'Obligated Amount',
                        data: months.map(m => monthlyData[m]),
                        backgroundColor: 'rgba(37, 99, 235, 0.7)',
                        borderColor: 'rgba(37, 99, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => formatCurrency(ctx.raw)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (val) => formatCurrencyCompact(val)
                            }
                        }
                    }
                }
            });

// Contractor chart
const contractorTotals = {};
allTaskOrders.forEach(to => {
const name = to.contractor_name || 'Unknown';
contractorTotals[name] = (contractorTotals[name] || 0) + (to.total_obligated_amount || 0);
});
            const topContractors = Object.entries(contractorTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

charts.contractor = new Chart(document.getElementById('contractorChart'), {
type: 'bar',
data: {
labels: topContractors.map(c => c[0].substring(0, 25)),
datasets: [{
label: 'Total Obligated',
data: topContractors.map(c => c[1]),
backgroundColor: 'rgba(5, 150, 105, 0.7)',
borderColor: 'rgba(5, 150, 105, 1)',
borderWidth: 1
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => formatCurrency(ctx.raw)
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                callback: (val) => formatCurrencyCompact(val)
                            }
                        }
                    }
                }
            });

// Agency pie chart
const agencyTotals = {};
allTaskOrders.forEach(to => {
const agency = to.contracting_agency || 'Unknown';
agencyTotals[agency] = (agencyTotals[agency] || 0) + (to.total_obligated_amount || 0);
});
            const topAgencies = Object.entries(agencyTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);

            charts.agency = new Chart(document.getElementById('agencyChart'), {
                type: 'doughnut',
                data: {
                    labels: topAgencies.map(a => a[0]),
                    datasets: [{
                        data: topAgencies.map(a => a[1]),
                        backgroundColor: [
                            '#2563eb', '#059669', '#d97706', '#dc2626',
                            '#0891b2', '#7c3aed', '#db2777', '#65a30d'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { font: { size: 11 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.label}: ${formatCurrency(ctx.raw)}`
                            }
                        }
                    }
                }
            });

            // Distribution chart
            const ranges = {
                '$0': 0,
                '$1 - $10K': 0,
                '$10K - $100K': 0,
                '$100K - $1M': 0,
                '$1M - $10M': 0,
                '$10M+': 0
            };
allTaskOrders.forEach(to => {
const amt = to.total_obligated_amount || 0;
if (amt === 0) ranges['$0']++;
else if (amt < 10000) ranges['$1 - $10K']++;
else if (amt < 100000) ranges['$10K - $100K']++;
else if (amt < 1000000) ranges['$100K - $1M']++;
else if (amt < 10000000) ranges['$1M - $10M']++;
else ranges['$10M+']++;
});

            charts.distribution = new Chart(document.getElementById('distributionChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(ranges),
                    datasets: [{
                        label: 'Number of Task Orders',
                        data: Object.values(ranges),
                        backgroundColor: 'rgba(217, 119, 6, 0.7)',
                        borderColor: 'rgba(217, 119, 6, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').style.display = 'block';
        }

        // Detail modal
        function showDetail(piid) {
            const to = allTaskOrders.find(t => t.piid === piid);
            if (!to) return;

            document.getElementById('modalTitle').textContent = `Task Order: ${piid}`;
            document.getElementById('modalBody').innerHTML = `
                <div class="contractor-panel">
                    <div class="detail-label">Contractor</div>
                    <div class="detail-value large">${to.vendor_name || 'N/A'}</div>
                    <div class="contractor-stats">
                        <div class="detail-item">
                            <div class="detail-label">Obligated Amount</div>
                            <div class="detail-value" style="color: var(--primary);">${formatCurrency(to.obligated_amount)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Obligated</div>
                            <div class="detail-value">${formatCurrency(to.total_obligated_amount)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Base + Options</div>
                            <div class="detail-value">${formatCurrency(to.base_and_all_options_value)}</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">PIID</div>
                        <div class="detail-value"><code>${to.piid}</code></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Modification</div>
                        <div class="detail-value">${to.mod_number || '0'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Contract Type</div>
                        <div class="detail-value">${to.contract_type || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Action Type</div>
                        <div class="detail-value">${to.action_type_description || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Signed Date</div>
                        <div class="detail-value">${formatDate(to.signed_date)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Effective Date</div>
                        <div class="detail-value">${formatDate(to.effective_date)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Completion Date</div>
                        <div class="detail-value">${formatDate(to.completion_date)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">First Seen</div>
                        <div class="detail-value">${formatDate(to.first_seen)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Contracting Agency</div>
                        <div class="detail-value">${to.contracting_agency || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Contracting Office</div>
                        <div class="detail-value">${to.contracting_office || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Funding Agency</div>
                        <div class="detail-value">${to.funding_agency || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Place of Performance</div>
                        <div class="detail-value">${to.pop_city || ''} ${to.pop_state || ''} ${to.pop_country || ''}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">NAICS Code</div>
                        <div class="detail-value">${to.naics_code || 'N/A'} - ${to.naics_description || ''}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">PSC Code</div>
                        <div class="detail-value">${to.psc_code || 'N/A'} - ${to.psc_description || ''}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Business Size</div>
                        <div class="detail-value">${to.business_size || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Set Aside</div>
                        <div class="detail-value">${to.set_aside || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Extent Competed</div>
                        <div class="detail-value">${to.extent_competed || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Contract Pricing</div>
                        <div class="detail-value">${to.contract_pricing || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Vendor UEI</div>
                        <div class="detail-value"><code>${to.uei || 'N/A'}</code></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Parent Company</div>
                        <div class="detail-value">${to.parent_name || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Parent UEI</div>
                        <div class="detail-value"><code>${to.parent_uei || 'N/A'}</code></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">CAGE Code</div>
                        <div class="detail-value">${to.cage_code || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Vendor Location</div>
                        <div class="detail-value">${to.vendor_city || ''}, ${to.vendor_state || ''} ${to.vendor_zip || ''}</div>
                    </div>
                </div>
                
                <div class="detail-item mt-20">
                    <div class="detail-label">Description</div>
                    <div class="detail-value" style="white-space: pre-wrap;">${to.description || 'N/A'}</div>
                </div>
                
                <div class="detail-item mt-20">
                    <div class="detail-label">FPDS Link</div>
                    <div class="detail-value">
                        ${to.fpds_link ? `<a href="${to.fpds_link}" target="_blank" style="color: var(--primary);">View on FPDS.gov ‚Üí</a>` : 'N/A'}
                    </div>
                </div>
            `;

            document.getElementById('detailModal').classList.add('active');
        }

        function closeModal(event) {
            if (!event || event.target.id === 'detailModal') {
                document.getElementById('detailModal').classList.remove('active');
            }
        }

        function filterByContractor(name) {
            switchTab('taskorders');
            document.getElementById('vendorFilter').value = name;
            applyFilters();
            document.querySelector('.tab.active').classList.remove('active');
            document.querySelectorAll('.tab')[0].classList.add('active');
        }

        // Export functions
        function toggleExportMenu() {
            document.getElementById('exportMenu').classList.toggle('active');
        }

        function exportCSV() {
            const headers = ['PIID', 'Vendor', 'Obligated Amount', 'Signed Date', 'Agency', 'Office', 'Description', 'IDV PIID', 'Contractor', 'State'];
            const rows = filteredTaskOrders.map(to => [
                to.piid,
                to.vendor_name,
                to.obligated_amount,
                to.signed_date,
                to.contracting_agency,
                to.contracting_office,
                (to.description || '').replace(/,/g, ';'),
                to.idv_piid,
                to.contractor_name,
                to.pop_state || to.vendor_state
            ]);

            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            downloadFile(csv, 'wexmac_task_orders.csv', 'text/csv');
            toggleExportMenu();
        }

        function exportJSON() {
            const json = JSON.stringify(filteredTaskOrders, null, 2);
            downloadFile(json, 'wexmac_task_orders.json', 'application/json');
            toggleExportMenu();
        }

        function exportExcel() {
            // Simple HTML table for Excel compatibility
            const headers = ['PIID', 'Vendor', 'Obligated Amount', 'Signed Date', 'Agency', 'Description', 'IDV PIID'];
            const rows = filteredTaskOrders.map(to => `
                <tr>
                    <td>${to.piid}</td>
                    <td>${to.vendor_name}</td>
                    <td>${to.obligated_amount}</td>
                    <td>${to.signed_date}</td>
                    <td>${to.contracting_agency}</td>
                    <td>${escapeHtml(to.description || '')}</td>
                    <td>${to.idv_piid}</td>
                </tr>
            `).join('');

            const html = `
                <table>
                    <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            `;

            downloadFile(html, 'wexmac_task_orders.xls', 'application/vnd.ms-excel');
            toggleExportMenu();
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Utility functions
        function formatCurrency(val) {
            if (val === null || val === undefined) return '$0.00';
            return '$' + val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatCurrencyCompact(val) {
            if (val >= 1e9) return '$' + (val / 1e9).toFixed(1) + 'B';
            if (val >= 1e6) return '$' + (val / 1e6).toFixed(1) + 'M';
            if (val >= 1e3) return '$' + (val / 1e3).toFixed(1) + 'K';
            return '$' + val.toFixed(0);
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr.substring(0, 10);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

// Toggle description expand/collapse
function toggleDescription(descId, showFull) {
const shortDiv = document.getElementById(`${descId}-short`);
const fullDiv = document.getElementById(`${descId}-full`);
if (showFull) {
shortDiv.style.display = 'none';
fullDiv.style.display = 'block';
} else {
shortDiv.style.display = 'block';
fullDiv.style.display = 'none';
}
}

// Close export menu when clicking outside
document.addEventListener('click', (e) => {
if (!e.target.closest('.export-menu')) {
document.getElementById('exportMenu').classList.remove('active');
}
});
</script>
</body>
</html>
