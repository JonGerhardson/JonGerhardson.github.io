<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Name Lookup</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Use the Inter font loaded by Tailwind */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple spinner for loading */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* --- Restored Fade-in animation --- */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fade-in-card {
            animation: fadeIn 0.7s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen flex items-center justify-center p-4">

    <!-- Added the fade-in-card class for the animation -->
    <div class="bg-white rounded-lg shadow-xl p-6 md:p-8 w-full max-w-lg fade-in-card">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4 text-center">
            Are you in the Epstein files?
        </h1>
        <p class="text-gray-600 mb-6 text-center">
            Enter a name to find out.
        </p>

        <!-- Search Input and Button -->
        <div class="flex flex-col sm:flex-row gap-2">
            <input 
                type="text" 
                id="nameInput"
                placeholder="Enter name"
                class="flex-grow w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
            >
            <button 
                id="searchButton"
                onclick="checkName()"
                class="w-full sm:w-auto bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200 ease-in-out disabled:bg-gray-400 disabled:cursor-not-allowed"
            >
                Search
            </button>
        </div>
        
        <!-- Data Source Link -->
        <p class="text-xs text-gray-400 text-center mt-3">
            Based on data from the <a href="https://oversight.house.gov/release/oversight-committee-releases-additional-epstein-estate-documents/" class="text-indigo-600 hover:underline" target="_blank" rel="noopener noreferrer">House Oversight Committee</a>.
        </p>

        <!-- Loading Message -->
        <div id="loadingMessage" class="flex items-center justify-center gap-2 text-gray-500 mt-6">
            <div class="spinner"></div>
            <span>Loading name list...</span>
        </div>

        <!-- Result Display -->
        <div id="result" class="mt-8 text-center min-h-[50px] flex items-center justify-center">
            <!-- Result will be injected here -->
        </div>

        <!-- Search Counter -->
        <!-- This is text-xs as requested -->
        <div id="counter" class="text-center text-xs text-gray-400 mt-6">
            Total Searches: 0
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Use a Map to store names (lowercase) and their counts.
        const nameMap = new Map();
        
        // --- Globals for Firebase and Counter ---
        let db;
        let counterRef;
        let currentSearchCount = 0;
        const counterSpan = document.getElementById('counter');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        /**
         * Robustly parses the CSV text (name,count) and populates the nameMap.
         * Handles quoted fields, escaped quotes (""), and newlines within fields.
         */
        function parseCsvAndFillMap(csvText) {
            // Skip header line
            const headerEnd = csvText.indexOf('\n');
            if (headerEnd === -1) {
                console.error("CSV appears to have no header or is empty.");
                return;
            }
            const dataText = csvText.substring(headerEnd + 1);

            let currentField = "";
            let inQuotes = false;
            let fields = [];

            for (let i = 0; i < dataText.length; i++) {
                const char = dataText[i];

                if (inQuotes) {
                    if (char === '"') {
                        if (i + 1 < dataText.length && dataText[i + 1] === '"') {
                            // Escaped quote (e.g., "jeffrey E.""")
                            currentField += '"';
                            i++; // Skip the next quote
                        } else {
                            // End of quote
                            inQuotes = false;
                        }
                    } else {
                        // Regular character inside quotes (including newlines)
                        currentField += char;
                    }
                } else {
                    if (char === '"') {
                        inQuotes = true;
                        // Handle cases where a quote is not at the start of a field (technically malformed)
                        if (currentField.length > 0) {
                            currentField += '"';
                        }
                    } else if (char === ',') {
                        // End of a field
                        fields.push(currentField.trim());
                        currentField = ""; // Reset for next field
                    } else if (char === '\n' || char === '\r') {
                        // End of a line
                        fields.push(currentField.trim()); // Push the last field (the count)

                        if (fields.length >= 2) {
                            const name = fields[0].toLowerCase(); // Get name, convert to lowercase
                            const count = parseInt(fields[1], 10); // Get count

                            if (name && !isNaN(count)) {
                                nameMap.set(name, count);
                            }
                        }
                        
                        // Reset for the next line
                        fields = [];
                        currentField = ""; 
                        
                        // Handle \r\n line endings
                        if (char === '\r' && i + 1 < dataText.length && dataText[i + 1] === '\n') {
                            i++; // Skip the \n
                        }
                    } else {
                        // Regular character
                        currentField += char;
                    }
                }
            }

            // Add the very last line if the file doesn't end with a newline
            if (currentField.trim().length > 0 || fields.length > 0) {
                 fields.push(currentField.trim());
                 if (fields.length >= 2) {
                    const name = fields[0].toLowerCase();
                    const count = parseInt(fields[1], 10);
                    if (name && !isNaN(count)) {
                        nameMap.set(name, count);
                    }
                }
            }

            // Clean up any empty strings that might have been added
            nameMap.delete("");
        }

        /**
         * Loads the initial search count from Firebase.
         */
        async function loadInitialCounter() {
            if (!counterRef) return; // Guard if Firebase init fails
            
            counterSpan.textContent = "Loading searches...";
            try {
                const docSnap = await getDoc(counterRef);
                if (docSnap.exists()) {
                    currentSearchCount = docSnap.data().count || 0;
                }
                counterSpan.textContent = `Total Searches: ${currentSearchCount.toLocaleString()}`;
            } catch (error) {
                console.error("Error loading counter:", error);
                counterSpan.textContent = "Total Searches: 0"; // Fallback
            }
        }

        /**
         * Increments the search counter locally and updates Firebase.
         */
        async function incrementSearchCounter() {
            if (!counterRef) return; // Guard if Firebase init fails

            currentSearchCount++;
            // Update UI immediately for responsiveness
            counterSpan.textContent = `Total Searches: ${currentSearchCount.toLocaleString()}`;
            
            // Asynchronously update Firebase
            try {
                // Use setDoc to create or overwrite
                await setDoc(counterRef, { count: currentSearchCount });
            } catch (error)
                console.error("Error updating counter:", error);
                // If this fails, the local count will be out of sync
                // On next page load, it will correct itself.
            }
        }

        // Function to check the name, called by the button
        function checkName() {
            // Increment the counter on every search click
            incrementSearchCounter();

            const input = document.getElementById('nameInput').value;
            const resultDiv = document.getElementById('result');
            
            // Get the exact string from the input, trim whitespace, and convert to lowercase
            const nameToFind = input.trim().toLowerCase(); 

            if (nameMap.has(nameToFind)) {
                const count = nameMap.get(nameToFind);
                const timesText = count === 1 ? 'time' : 'times';
                
                // --- Show image with text overlay, using relative path for bill.jpg ---
                resultDiv.innerHTML = `
                    <div class="relative w-full max-w-sm rounded-lg overflow-hidden shadow-lg">
                        <img src="bill.jpg" 
                             alt="Image result" 
                             class="w-full h-auto object-cover">
                        <div class="absolute inset-0 flex items-center justify-center p-4 bg-black bg-opacity-40">
                            <span class="text-4xl font-bold text-white text-center drop-shadow-md">
                                Yes, ${count} ${timesText}.
                            </span>
                        </div>
                    </div>
                `;
                // Reset class to remove old text styles
                resultDiv.className = 'mt-8 text-center min-h-[50px] flex items-center justify-center';
            } else {
                // --- Show "No." as before ---
                resultDiv.innerHTML = "No.";
                // Apply smaller, black styles
                resultDiv.className = 'mt-8 text-center min-h-[50px] flex items-center justify-center text-xl font-medium text-black';
            }
        }
        // Attach checkName to the window object so onclick can find it
        window.checkName = checkName;


        // Populate the map by fetching the CSV when the page loads
        window.onload = async function() {
            const searchButton = document.getElementById('searchButton');
            const loadingMessage = document.getElementById('loadingMessage');
            const nameInput = document.getElementById('nameInput');

            // Disable search button initially
            searchButton.disabled = true;

            // --- Initialize Firebase and Load Counter ---
            try {
                // Use provided Firebase config
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app); // Assign to global 'db'
                const auth = getAuth(app);
                setLogLevel('Debug'); // Enable Firestore debug logging

                // Authenticate
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Define the counter reference
                counterRef = doc(db, `/artifacts/${appId}/public/data/analytics/pageCounter`);
                
                // Load the initial count from Firebase
                await loadInitialCounter();

            } catch (error) {
                console.error("Firebase init or counter load error:", error);
                counterSpan.textContent = "Counter unavailable";
            }
            
            // --- Fetch and Parse CSV ---
            // Using a placeholder for the CSV path. 
            // Replace 'names_found_in_001.csv' if the file is hosted elsewhere.
            fetch('names_found_in_001.csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    parseCsvAndFillMap(csvText);
                    
                    // Enable search functionality
                    searchButton.disabled = false;
                    loadingMessage.style.display = 'none';

                    // Add 'Enter' key listener to the input field
                    nameInput.addEventListener('keydown', function(event) {
                        if (event.key === 'Enter') {
                            // Only search if the button is not disabled
                            if (!searchButton.disabled) {
                                checkName();
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching or parsing CSV:', error);
                    loadingMessage.innerHTML = '<strong>Error loading name list.</strong><br>Please check the console and ensure the file `names_found_in_001.csv` is accessible.';
                    loadingMessage.classList.remove('text-gray-500');
                    loadingMessage.classList.add('text-red-600');
                    // Ensure spinner is gone
                    const spinner = loadingMessage.querySelector('.spinner');
                    if (spinner) spinner.style.display = 'none';
                });
        };
    </script>

</body>
</html>
